[Назад](../designmenu.md)

# A pattern language for microservices

<img src="MicroservicePatternLanguage.jpg" alt="comp">

## Application patterns (Паттерны приложения)
    
 ### Decomposition (Декомпозиция)
   - #### [Decompose by business capability (Декомпозиция по бизнес-возможностям)](#Decompose-by-business-capability)
   - #### [Decompose by subdomain DDD (Декомпозиция по сабдоменам DDD)](#decompose-by-subdomain-DDD)
   - #### [Self-contained Service (Автономный сервис)](#self-contained-service)
   - #### [Service per team (Сервис на команду)](#service-per-team)
   - #### [Strangler application](#strangler-application)

 ### Data patterns (Паттерны управления данными)
   - ### Database architecture (Архитектура БД)
        - #### [Database per Service (Отдельная БД на каждый сервис)](#Database-per-Service)
        - #### [Shared database (Сервисы работают с единой БД)](#Shared-database)
   - ### Maintaining data consistency (Управление констистентностью данных)
        - #### [Saga pattern](#saga)
   - ### Querying (Запросы)

 ### Testing (Тестирование)

 ### UI (Графический интерфейс)

 ### Observability (Наблюдаемость)



## Application Infrastructure patterns (Паттерны инфраструктуры приложения)

### Cross-cutting concerns (Сквозные проблемы)
### Security (Безопасность)
### Deployment (Развертывание приложения)
### Communication patterns (Паттерны коммуникации)
  - ### Transactional Messaging (Транзакционный обмен сообщениями)
  - ### Communication Style (Стиль коммуникаций)
  - ### Reliability (Надежность)
  - ### External API (Внешний API)
  - ### Discovery (Наблюдаемость)
### Observability (Наблюдаемость)


## Infrastructure patterns (Инфраструктурные паттерны)

### Deployment (Развертывание приложения)
### Communication patterns (Паттерны коммуникации)
- ### Discovery (Наблюдаемость)



## Decompose by business capability

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps) 
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Decompose by subdomain DDD

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Self-contained Service

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Service per team

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Strangler application

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Database per Service

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Shared database

В наши дни программное обеспечение обычно распространяется в виде сервисов, называемых веб-приложения (web apps)
или software-as-a-service (SaaS). Приложение двенадцати факторов — это методология для создания SaaS-приложений, которые:


[к оглавлению](#a-pattern-language-for-microservices)


## Saga

#### Контекст
В приложении применяется паттерн [Database per service](#database-per-service). Каждый микросервис имеет свою базу данных. 
Однако некоторые бизнес-транзакции охватывают несколько микросервисов, поэтому вам нужен механизм для реализации транзакций, 
охватывающих эти микросервисы. Например, предположим, что вы создаете интернет-магазин, в котором у клиентов есть кредитный лимит. 
Приложение должно гарантировать, что новый заказ не превысит кредитный лимит клиента. Поскольку заказы и клиенты находятся 
в разных базах данных, принадлежащих разным микросервисам, приложение не может использовать локальную ACID транзакцию.

#### Проблема
Как реализовать транзакции, охватывающие эти микросервисы? 2PC не вариант.

#### Решение
Реализуйте каждую бизнес-транзакцию, охватывающую несколько микросервисов, как сагу. Сага — это последовательность 
локальных транзакций. Каждая локальная транзакция обновляет базу данных, относящуюся к определенному микросервису
и публикует сообщение или событие, запускающее следующую локальную транзакцию в саге. Если локальная транзакция завершается 
с ошибкой из-за нарушения бизнес-правила, сага выполняет серию компенсирующих транзакций, которые отменяют изменения, 
внесенные предыдущими локальными транзакциями.
Существует два способа координации саг:
+ Хореография — каждая локальная транзакция публикует события домена, которые запускают локальные транзакции в других микросервисах.
+ Оркестрация — оркестратор (объект) сообщает участникам, какие локальные транзакции выполнять.

#### Пример: сага, основанная на хореографии.
<img src="Create_Order_Saga.png" alt="comp">

Приложение электронной коммерции, использующее этот подход, создаст заказ, используя хореографическую сагу, 
состоящую из следующих шагов:

+ Микросервис OrderService получает запрос POST/orders и создает заказ в состоянии PENDING.
+ Затем он генерирует событие Order Created.
+ Обработчик событий микросервиса CustomerService пытается зарезервировать продукт
+ Затем он генерирует событие, указывающее результат
+ Обработчик событий микросервиса OrderService либо утверждает, либо отклоняет заказ.



[к оглавлению](#a-pattern-language-for-microservices)



# Источники
+ [Сайт книги Сэма Ньюмена о паттернах микросервисов](https://microservices.io/patterns/index.html)

[Назад](../designmenu.md)
